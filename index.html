<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cinematic Camera Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg: #030712;
  --accent: #48ffdc;
  --accent-soft: rgba(72,255,220,0.35);
  --danger: #ff4b81;
  --glass: rgba(15,23,42,0.72);
  --glass-soft: rgba(15,23,42,0.55);
  --border-glow: rgba(72,255,220,0.55);
  --text-main:#e5e7eb;
  --text-soft:#9ca3af;
  --neon:#7c3aed;
  --yellow:#fbbf24;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{
  width:100%;
  height:100%;
  background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
  color:var(--text-main);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
  -webkit-font-smoothing:antialiased;
}
body{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px;
}
.app-root{
  position:relative;
  width:100%;
  max-width:1200px;
  height:100%;
  max-height:720px;
  border-radius:26px;
  overflow:hidden;
  background: radial-gradient(circle at top left, rgba(56,189,248,0.18),transparent 55%),
              radial-gradient(circle at bottom right, rgba(180,83,9,0.22),transparent 60%),
              linear-gradient(135deg,#020617,#020617);
  box-shadow:
    0 0 1px rgba(15,23,42,0.9),
    0 24px 60px rgba(0,0,0,0.85),
    0 0 80px rgba(72,255,220,0.12);
  display:grid;
  grid-template-columns:minmax(0,3fr) minmax(260px,2fr);
  grid-template-rows:1fr;
  gap:0;
  backdrop-filter:blur(26px);
}
@media (max-width:900px){
  .app-root{
    grid-template-columns:1fr;
    grid-template-rows:auto minmax(260px, 42%);
    height:100%;
  }
}
.left-pane{
  position:relative;
  overflow:hidden;
}
.right-pane{
  position:relative;
  padding:14px 14px 10px 10px;
  background:linear-gradient(160deg,rgba(15,23,42,0.92),rgba(3,7,18,0.92));
  border-left:1px solid rgba(148,163,184,0.25);
  display:flex;
  flex-direction:column;
  gap:8px;
}
@media (max-width:900px){
  .right-pane{
    border-left:none;
    border-top:1px solid rgba(148,163,184,0.25);
  }
}
.glass-header{
  position:absolute;
  top:10px;
  left:12px;
  right:12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 10px;
  border-radius:18px;
  background:linear-gradient(135deg,rgba(15,23,42,0.82),rgba(15,23,42,0.55));
  border:1px solid rgba(148,163,184,0.4);
  box-shadow:0 12px 30px rgba(0,0,0,0.55);
  backdrop-filter:blur(18px);
  z-index:15;
}
.brand-title{
  display:flex;
  align-items:center;
  gap:8px;
}
.brand-dot{
  width:12px;
  height:12px;
  border-radius:999px;
  background:radial-gradient(circle,var(--accent) 0%,var(--neon) 40%,transparent 70%);
  box-shadow:0 0 18px var(--accent-soft);
}
.brand-main{
  font-size:14px;
  letter-spacing:0.14em;
  text-transform:uppercase;
  color:#e5e7eb;
}
.brand-sub{
  font-size:11px;
  text-transform:uppercase;
  color:var(--text-soft);
}
.header-status{
  display:flex;
  align-items:center;
  gap:8px;
}
.badge{
  padding:4px 8px;
  border-radius:999px;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.14em;
  border:1px solid rgba(148,163,184,0.5);
  background:rgba(15,23,42,0.85);
  color:var(--text-soft);
}
.badge.accent{
  border-color:var(--border-glow);
  color:var(--accent);
  box-shadow:0 0 10px rgba(72,255,220,0.45);
}
.preview-shell{
  position:absolute;
  inset:0;
  padding:44px 16px 54px 16px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.preview-frame{
  position:relative;
  width:100%;
  height:100%;
  max-width:100%;
  border-radius:22px;
  overflow:hidden;
  background:radial-gradient(circle at center,#020617, #000 70%);
  border:1px solid rgba(148,163,184,0.4);
  box-shadow:
    0 30px 80px rgba(0,0,0,0.9),
    0 0 0 1px rgba(15,23,42,1);
}
video#camera{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
}
canvas#photoCanvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}
.preview-overlay{
  pointer-events:none;
  position:absolute;
  inset:0;
}
.letterbox{
  position:absolute;
  left:0;
  right:0;
  height:10%;
  max-height:72px;
  background:linear-gradient(to bottom,rgba(0,0,0,0.95),rgba(0,0,0,0.7));
  z-index:6;
}
.letterbox.bottom{
  bottom:0;
  top:auto;
  background:linear-gradient(to top,rgba(0,0,0,0.97),rgba(0,0,0,0.7));
}
.frame-lines{
  position:absolute;
  inset:8%;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.28);
  box-shadow:0 0 0 1px rgba(15,23,42,0.9),0 0 40px rgba(0,0,0,0.95);
  mix-blend-mode:screen;
}
.frame-lines::before,
.frame-lines::after{
  content:"";
  position:absolute;
  left:50%;
  top:0;
  bottom:0;
  width:1px;
  background:linear-gradient(to bottom,transparent,rgba(148,163,184,0.55),transparent);
}
.frame-lines::after{
  top:50%;
  left:0;
  right:0;
  height:1px;
  width:auto;
  background:linear-gradient(to right,transparent,rgba(148,163,184,0.4),transparent);
}
.film-grain{
  pointer-events:none;
  position:absolute;
  inset:-40px;
  background-image:
    radial-gradient(circle at 10% 20%,rgba(255,255,255,0.05) 0,transparent 50%),
    radial-gradient(circle at 80% 0,rgba(148,163,184,0.06) 0,transparent 40%),
    radial-gradient(circle at 0 80%,rgba(15,23,42,0.75) 0,transparent 55%);
  mix-blend-mode:soft-light;
  opacity:0.55;
  animation:grainShift 9s steps(10,end) infinite;
}
@keyframes grainShift{
  0%{transform:translate3d(0,0,0);}
  50%{transform:translate3d(-18px,10px,0);}
  100%{transform:translate3d(18px,-12px,0);}
}
.music-visualizer{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:12%;
  display:flex;
  gap:3px;
  height:18px;
  opacity:0.0;
  transition:opacity 0.4s ease-out;
  z-index:10;
}
.music-visualizer .bar{
  width:4px;
  border-radius:999px;
  background:linear-gradient(to top,var(--accent),var(--neon));
  box-shadow:0 0 8px rgba(72,255,220,0.7);
  transform-origin:bottom;
}
.music-visualizer.active{
  opacity:1;
}
.bottom-controls{
  position:absolute;
  left:0;
  right:0;
  bottom:6px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  z-index:16;
}
.capture-cluster{
  display:flex;
  align-items:center;
  gap:14px;
}
.icon-button{
  width:34px;
  height:34px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.55);
  background:radial-gradient(circle at top,rgba(15,23,42,0.7),rgba(15,23,42,0.95));
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--text-soft);
  font-size:16px;
  cursor:pointer;
  box-shadow:0 10px 24px rgba(0,0,0,0.9);
  backdrop-filter:blur(12px);
  transition:transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease,color 0.15s ease,background 0.15s ease;
}
.icon-button:active{
  transform:translateY(1px) scale(0.97);
  box-shadow:0 6px 12px rgba(0,0,0,0.8);
}
.icon-button.primary{
  border-color:var(--border-glow);
  color:var(--accent);
  box-shadow:0 0 0 1px rgba(72,255,220,0.6), 0 0 32px rgba(72,255,220,0.46);
}
.icon-button.danger{
  border-color:var(--danger);
  color:var(--danger);
}
.shutter-shell{
  width:72px;
  height:72px;
  border-radius:999px;
  border:2px solid rgba(15,23,42,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  background:radial-gradient(circle at top,rgba(30,64,175,0.4),rgba(15,23,42,1));
  box-shadow:
    0 0 0 1px rgba(15,23,42,1),
    0 16px 40px rgba(0,0,0,1),
    0 0 40px rgba(72,255,220,0.18);
}
.shutter-button{
  width:56px;
  height:56px;
  border-radius:999px;
  border:2px solid rgba(15,23,42,0.9);
  background:radial-gradient(circle at top,#f9fafb,#e5e7eb);
  box-shadow:0 0 0 1px rgba(15,23,42,0.9),0 10px 20px rgba(0,0,0,0.9);
  cursor:pointer;
  position:relative;
  transition:transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
}
.shutter-button::after{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:inherit;
  border:1px solid rgba(148,163,184,0.4);
}
.shutter-button.recording{
  background:radial-gradient(circle at top,var(--danger),#991b1b);
}
.shutter-button:active{
  transform:translateY(1px) scale(0.97);
  box-shadow:0 6px 14px rgba(0,0,0,0.9);
}
.mode-toggle{
  display:flex;
  align-items:center;
  gap:4px;
  padding:4px;
  border-radius:999px;
  background:rgba(15,23,42,0.9);
  border:1px solid rgba(148,163,184,0.45);
  box-shadow:0 12px 30px rgba(0,0,0,0.8);
}
.mode-chip{
  padding:4px 8px;
  border-radius:999px;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.15em;
  color:var(--text-soft);
  cursor:pointer;
  white-space:nowrap;
  transition:background 0.15s ease,color 0.15s ease;
}
.mode-chip.active{
  background:radial-gradient(circle at top,var(--accent-soft),rgba(72,255,220,0.12));
  color:var(--accent);
}
.mode-chip.burst-active{
  color:var(--yellow);
}
.status-indicator{
  position:absolute;
  top:54px;
  left:50%;
  transform:translateX(-50%);
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  background:rgba(15,23,42,0.88);
  border:1px solid rgba(148,163,184,0.55);
  color:var(--text-soft);
  display:flex;
  align-items:center;
  gap:6px;
  box-shadow:0 14px 30px rgba(0,0,0,0.85);
  z-index:15;
}
.status-dot{
  width:7px;
  height:7px;
  border-radius:999px;
  background:radial-gradient(circle,var(--accent) 0%,transparent 65%);
  box-shadow:0 0 10px rgba(72,255,220,0.7);
}
.status-dot.rec{
  background:radial-gradient(circle,var(--danger) 0%,transparent 65%);
  box-shadow:0 0 12px rgba(248,113,113,0.9);
}
.status-indicator.hidden{
  opacity:0;
  pointer-events:none;
}
.timer-indicator{
  font-variant-numeric:tabular-nums;
}
.gallery-strip{
  flex:1;
  min-height:0;
  background:radial-gradient(circle at top left,rgba(55,65,81,0.35),rgba(15,23,42,0.95));
  border-radius:18px;
  border:1px solid rgba(148,163,184,0.35);
  padding:8px 10px;
  box-shadow:0 12px 30px rgba(0,0,0,0.65);
  display:flex;
  flex-direction:column;
}
.gallery-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.gallery-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.18em;
  color:var(--text-soft);
}
.gallery-actions{
  display:flex;
  align-items:center;
  gap:6px;
}
.mini-pill{
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.6);
  color:var(--text-soft);
  background:rgba(15,23,42,0.9);
  cursor:pointer;
}
.mini-pill.danger{
  border-color:rgba(239,68,68,0.85);
  color:#fecaca;
}
.gallery-grid{
  flex:1;
  min-height:0;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(72px,1fr));
  gap:6px;
  overflow-y:auto;
  padding-right:4px;
}
.gallery-item{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  border:1px solid rgba(148,163,184,0.45);
  cursor:pointer;
  background:#020617;
}
.gallery-item img,
.gallery-item video{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
.gallery-tag{
  position:absolute;
  bottom:4px;
  left:4px;
  padding:2px 5px;
  border-radius:999px;
  background:rgba(15,23,42,0.8);
  font-size:9px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:var(--accent);
}
.gallery-badge{
  position:absolute;
  top:4px;
  right:4px;
  width:16px;
  height:16px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.8);
  background:rgba(15,23,42,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:9px;
  color:var(--text-soft);
}
.scrollbar-hide::-webkit-scrollbar{width:0;height:0;}
.scrollbar-hide{scrollbar-width:none;}
.control-section{
  padding:6px 8px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--glass),var(--glass-soft));
  border:1px solid rgba(148,163,184,0.3);
  box-shadow:0 12px 26px rgba(0,0,0,0.88);
}
.control-section + .control-section{
  margin-top:4px;
}
.section-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:var(--text-soft);
  margin-bottom:4px;
}
.chip-row{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.chip{
  padding:4px 7px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.5);
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.14em;
  color:var(--text-soft);
  cursor:pointer;
  background:rgba(15,23,42,0.95);
  transition:background 0.14s ease,color 0.14s ease,border-color 0.14s ease,box-shadow 0.14s ease;
}
.chip.active{
  color:var(--accent);
  border-color:var(--border-glow);
  box-shadow:0 0 16px rgba(72,255,220,0.5);
}
.chip.secondary-active{
  color:var(--yellow);
  border-color:rgba(251,191,36,0.8);
  box-shadow:0 0 12px rgba(251,191,36,0.6);
}
.chip.danger{
  color:var(--danger);
  border-color:var(--danger);
}
.toggle-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:4px;
}
.toggle{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--text-soft);
}
.toggle input{
  width:34px;
  height:18px;
}
.range-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:4px;
}
.range-row input[type=range]{
  flex:1;
}
.range-label{
  font-size:11px;
  color:var(--text-soft);
}
input[type=range]{
  -webkit-appearance:none;
  appearance:none;
  height:4px;
  border-radius:999px;
  background:rgba(31,41,55,0.9);
  outline:none;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  appearance:none;
  width:14px;
  height:14px;
  border-radius:50%;
  background:var(--accent);
  box-shadow:0 0 10px rgba(72,255,220,0.7);
  border:1px solid rgba(15,23,42,0.9);
}
input[type=range]::-moz-range-thumb{
  width:14px;
  height:14px;
  border-radius:50%;
  background:var(--accent);
  border:none;
}
.text-input-row{
  display:flex;
  gap:6px;
  margin-top:4px;
}
.text-input-row input{
  flex:1;
  border-radius:10px;
  border:1px solid rgba(148,163,184,0.5);
  background:rgba(15,23,42,0.9);
  color:var(--text-main);
  font-size:12px;
  padding:6px 8px;
  outline:none;
}
.text-input-row input::placeholder{
  color:var(--text-soft);
}
.small-btn{
  font-size:11px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.6);
  background:rgba(15,23,42,0.9);
  color:var(--text-soft);
  cursor:pointer;
}
.timeline-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:2px;
  font-size:11px;
  color:var(--text-soft);
}
.badge-soft{
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.5);
  background:rgba(15,23,42,0.9);
}
.badge-soft.accent{
  border-color:var(--border-glow);
  color:var(--accent);
}
.emoji-row{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  margin-top:4px;
}
.emoji-chip{
  padding:3px 6px;
  border-radius:999px;
  font-size:14px;
  cursor:pointer;
  border:1px solid rgba(148,163,184,0.4);
  background:rgba(15,23,42,0.96);
}
.emoji-chip:hover{
  border-color:var(--border-glow);
}
#downloadLink{
  display:none;
}
.canvas-layer{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}
#drawCanvas{
  pointer-events:none;
}
.meme-text{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  max-width:90%;
  text-align:center;
  font-weight:800;
  letter-spacing:0.14em;
  text-transform:uppercase;
  color:white;
  text-shadow:0 0 4px rgba(0,0,0,0.9),0 0 12px rgba(0,0,0,0.9);
  font-size:18px;
  padding:4px;
}
.meme-text.top{
  top:10%;
}
.meme-text.bottom{
  bottom:12%;
}
.meme-sticker{
  position:absolute;
  font-size:38px;
  cursor:move;
}
@media (max-width:600px){
  .glass-header{
    padding-inline:8px;
  }
  .brand-main{
    font-size:12px;
  }
  .status-indicator{
    top:50px;
  }
  .letterbox{
    height:12%;
  }
  .music-visualizer{
    bottom:16%;
  }
}
.hidden{
  display:none !important;
}
</style>
</head>
<body>
<div class="app-root">
  <div class="left-pane">
    <div class="glass-header">
      <div class="brand-title">
        <div class="brand-dot"></div>
        <div>
          <div class="brand-main">NEON LENS STUDIO</div>
          <div class="brand-sub">Cinematic Web Camera</div>
        </div>
      </div>
      <div class="header-status">
        <div class="badge accent" id="permissionBadge">Initializing</div>
        <div class="badge" id="privacyBadge">Privacy: Session Only</div>
      </div>
    </div>
    <div class="preview-shell">
      <div class="preview-frame" id="previewFrame">
        <video id="camera" playsinline autoplay muted></video>
        <canvas id="photoCanvas"></canvas>
        <canvas id="drawCanvas" class="canvas-layer"></canvas>
        <div class="preview-overlay">
          <div class="letterbox top"></div>
          <div class="letterbox bottom"></div>
          <div class="frame-lines"></div>
          <div class="film-grain" id="filmGrain"></div>
          <div class="music-visualizer" id="musicVisualizer">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>
        </div>
        <div class="status-indicator hidden" id="statusIndicator">
          <div class="status-dot" id="statusDot"></div>
          <div class="status-text" id="statusText">Ready</div>
          <div class="timer-indicator" id="timerIndicator"></div>
        </div>
        <div class="bottom-controls">
          <div class="capture-cluster">
            <button class="icon-button primary" id="switchCameraBtn" title="Switch camera">&#8646;</button>
            <button class="icon-button" id="mirrorBtn" title="Mirror mode">M</button>
            <button class="icon-button" id="flipBtn" title="Flip vertically">&#8645;</button>
          </div>
          <div class="shutter-shell">
            <button class="shutter-button" id="shutterBtn"></button>
          </div>
          <div class="mode-toggle">
            <div class="mode-chip active" id="photoModeChip">Photo</div>
            <div class="mode-chip" id="videoModeChip">Video</div>
            <div class="mode-chip" id="boomerangModeChip">Boom</div>
          </div>
        </div>
      </div>
    </div>
    <a id="downloadLink" download="capture.png"></a>
  </div>
  <div class="right-pane">
    <div class="control-section">
      <div class="section-title">Filters & Effects</div>
      <div class="chip-row" id="filtersRow">
        <div class="chip active" data-filter="none">Clean</div>
        <div class="chip" data-filter="bw">B&W</div>
        <div class="chip" data-filter="sepia">Sepia</div>
        <div class="chip" data-filter="neon">Neon</div>
        <div class="chip" data-filter="cyberpunk">Cyber</div>
        <div class="chip" data-filter="night">Night</div>
      </div>
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="portraitToggle">
          <span>Bokeh blur</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="grainToggle" checked>
          <span>Film grain</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="letterboxToggle" checked>
          <span>Letterbox</span>
        </label>
      </div>
    </div>

    <div class="control-section">
      <div class="section-title">Meme & Draw</div>
      <div class="text-input-row">
        <input type="text" id="memeTopInput" placeholder="Top text">
        <input type="text" id="memeBottomInput" placeholder="Bottom text">
      </div>
      <div class="emoji-row" id="emojiRow">
        <div class="emoji-chip">ðŸ”¥</div>
        <div class="emoji-chip">ðŸ˜Ž</div>
        <div class="emoji-chip">ðŸ˜‚</div>
        <div class="emoji-chip">ðŸ’«</div>
        <div class="emoji-chip">âœ¨</div>
        <div class="emoji-chip">ðŸŽ§</div>
      </div>
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="drawToggle">
          <span>Freehand draw</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="memeToggle">
          <span>Meme mode</span>
        </label>
      </div>
      <div class="range-row">
        <span class="range-label">Brush</span>
        <input type="range" min="2" max="22" value="8" id="brushRange">
      </div>
    </div>

    <div class="control-section">
      <div class="section-title">Timing & Audio</div>
      <div class="chip-row">
        <div class="chip" data-timer="0" id="timerNoneChip">Instant</div>
        <div class="chip" data-timer="3">3s</div>
        <div class="chip" data-timer="5">5s</div>
        <div class="chip" data-timer="10">10s</div>
        <div class="chip secondary-active" id="burstChip">Burst</div>
      </div>
      <div class="timeline-row">
        <div>Timer sound</div>
        <div class="badge-soft accent" id="audioStateBadge">On</div>
      </div>
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="musicReactiveToggle">
          <span>Music-reactive</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="vibrateToggle">
          <span>Vibrate shutter</span>
        </label>
      </div>
    </div>

    <div class="control-section">
      <div class="section-title">Session & Privacy</div>
      <div class="toggle-row">
        <label class="toggle">
          <input type="checkbox" id="privacyToggle" checked>
          <span>Privacy mode (no save)</span>
        </label>
      </div>
      <div class="timeline-row">
        <div>Session lifetime</div>
        <div class="badge-soft">Until tab closes</div>
      </div>
    </div>

    <div class="gallery-strip scrollbar-hide">
      <div class="gallery-header">
        <div class="gallery-title">Session Gallery</div>
        <div class="gallery-actions">
          <button class="mini-pill" id="saveAllBtn">Save Snapshot</button>
          <button class="mini-pill danger" id="clearGalleryBtn">Clear</button>
        </div>
      </div>
      <div class="gallery-grid scrollbar-hide" id="galleryGrid"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const video = document.getElementById('camera');
  const photoCanvas = document.getElementById('photoCanvas');
  const drawCanvas = document.getElementById('drawCanvas');
  const previewFrame = document.getElementById('previewFrame');
  const ctx = photoCanvas.getContext('2d');
  const drawCtx = drawCanvas.getContext('2d');

  let stream = null;
  let currentFacingMode = 'user';
  let usingExactDevice = null;

  let currentMode = 'photo';
  let currentFilter = 'none';
  let mirrorEnabled = true;
  let flipEnabled = false;
  let portraitBlur = false;
  let letterboxEnabled = true;
  let grainEnabled = true;
  let burstEnabled = false;
  let timerSeconds = 0;

  let drawingEnabled = false;
  let memeEnabled = false;
  let brushSize = 8;
  let isDrawing = false;
  let lastPoint = null;

  let currentMemeTop = '';
  let currentMemeBottom = '';
  const stickers = [];

  let mediaRecorder = null;
  let recordedChunks = [];
  let boomerangMode = false;

  let audioContext = null;
  let analyserNode = null;
  let musicReactive = false;
  const musicVisualizer = document.getElementById('musicVisualizer');
  const visualBars = Array.from(musicVisualizer.querySelectorAll('.bar'));

  const statusIndicator = document.getElementById('statusIndicator');
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const timerIndicator = document.getElementById('timerIndicator');
  const permissionBadge = document.getElementById('permissionBadge');
  const privacyBadge = document.getElementById('privacyBadge');
  const audioStateBadge = document.getElementById('audioStateBadge');
  const filmGrain = document.getElementById('filmGrain');

  const letterboxes = document.querySelectorAll('.letterbox');
  const galleryGrid = document.getElementById('galleryGrid');
  const downloadLink = document.getElementById('downloadLink');
  const previewRoot = document.querySelector('.preview-frame');

  let drawOffset = {x:0,y:0};
  let drawScale = {x:1,y:1};

  const shutterBtn = document.getElementById('shutterBtn');
  const switchCameraBtn = document.getElementById('switchCameraBtn');
  const mirrorBtn = document.getElementById('mirrorBtn');
  const flipBtn = document.getElementById('flipBtn');

  const photoModeChip = document.getElementById('photoModeChip');
  const videoModeChip = document.getElementById('videoModeChip');
  const boomerangModeChip = document.getElementById('boomerangModeChip');
  const burstChip = document.getElementById('burstChip');
  const timerNoneChip = document.getElementById('timerNoneChip');

  const filtersRow = document.getElementById('filtersRow');
  const portraitToggle = document.getElementById('portraitToggle');
  const grainToggle = document.getElementById('grainToggle');
  const letterboxToggle = document.getElementById('letterboxToggle');
  const memeTopInput = document.getElementById('memeTopInput');
  const memeBottomInput = document.getElementById('memeBottomInput');
  const emojiRow = document.getElementById('emojiRow');
  const drawToggle = document.getElementById('drawToggle');
  const memeToggle = document.getElementById('memeToggle');
  const brushRange = document.getElementById('brushRange');

  const musicReactiveToggle = document.getElementById('musicReactiveToggle');
  const vibrateToggle = document.getElementById('vibrateToggle');
  const privacyToggle = document.getElementById('privacyToggle');

  const saveAllBtn = document.getElementById('saveAllBtn');
  const clearGalleryBtn = document.getElementById('clearGalleryBtn');

  const timerChips = Array.from(document.querySelectorAll('.chip[data-timer]'));

  const shutterClickBuffer = createShutterSound();
  const timerBeepBuffer = createTimerBeep();

  let galleryItems = [];
  const STORAGE_KEY = 'neonLensSnapshot';

  function setStatus(text, type){
    statusText.textContent = text;
    statusIndicator.classList.remove('hidden');
    statusDot.classList.toggle('rec', type === 'rec');
    if(type !== 'rec'){
      timerIndicator.textContent = '';
    }
    if(type === 'info'){
      setTimeout(function(){
        statusIndicator.classList.add('hidden');
      }, 1800);
    }
  }

  function setPermissionState(ok){
    if(ok){
      permissionBadge.textContent = 'Camera Ready';
      permissionBadge.classList.add('accent');
    }else{
      permissionBadge.textContent = 'Permission Denied';
      permissionBadge.classList.remove('accent');
    }
  }

  function resizeCanvases(){
    const rect = previewFrame.getBoundingClientRect();
    photoCanvas.width = rect.width;
    photoCanvas.height = rect.height;
    drawCanvas.width = rect.width;
    drawCanvas.height = rect.height;
    drawOffset = {x:previewFrame.offsetLeft,y:previewFrame.offsetTop};
    drawScale = {x:1,y:1};
  }

  window.addEventListener('resize', function(){
    resizeCanvases();
  });

  async function initCamera(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      setStatus('Camera not supported', 'info');
      setPermissionState(false);
      return;
    }
    try{
      const constraints = {
        audio:true,
        video:{
          facingMode: usingExactDevice ? undefined : {ideal: currentFacingMode},
          deviceId: usingExactDevice ? {exact: usingExactDevice} : undefined
        }
      };
      if(stream){
        stream.getTracks().forEach(function(t){t.stop();});
      }
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      setPermissionState(true);
      setStatus('Live preview', 'info');
      resizeCanvases();
      if(musicReactive && !audioContext){
        initAudioAnalyser();
      }
    }catch(e){
      console.error(e);
      setPermissionState(false);
      if(e && (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError')){
        setStatus('Camera permission denied', 'info');
      }else{
        setStatus('Camera error', 'info');
      }
    }
  }

  async function switchCamera(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices){
      currentFacingMode = currentFacingMode === 'user' ? 'environment':'user';
      initCamera();
      return;
    }
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(function(d){return d.kind === 'videoinput';});
      if(videoDevices.length <= 1){
        currentFacingMode = currentFacingMode === 'user' ? 'environment':'user';
        usingExactDevice = null;
      }else{
        const currentIndex = videoDevices.findIndex(function(dev){
          if(!stream)return false;
          const track = stream.getVideoTracks();
          return track && track.getSettings && track.getSettings().deviceId === dev.deviceId;
        });
        const nextIndex = (currentIndex + 1) % videoDevices.length;
        usingExactDevice = videoDevices[nextIndex].deviceId;
      }
      await initCamera();
    }catch(e){
      console.error(e);
      currentFacingMode = currentFacingMode === 'user' ? 'environment':'user';
      usingExactDevice = null;
      initCamera();
    }
  }

  function applyFilter(ctx, w, h){
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    for(let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2];
      if(currentFilter === 'bw'){
        const v = (r+g+b)/3;
        data[i]=data[i+1]=data[i+2]=v;
      }else if(currentFilter === 'sepia'){
        data[i] = Math.min(255,0.393*r + 0.769*g + 0.189*b);
        data[i+1] = Math.min(255,0.349*r + 0.686*g + 0.168*b);
        data[i+2] = Math.min(255,0.272*r + 0.534*g + 0.131*b);
      }else if(currentFilter === 'neon'){
        data[i] = Math.min(255, 0.2*r + 0.9*g + 1.4*b);
        data[i+1] = Math.min(255, 0.9*r + 0.2*g + 1.2*b);
        data[i+2] = Math.min(255, 1.4*r + 1.1*g + 0.2*b);
      }else if(currentFilter === 'cyberpunk'){
        const nr = Math.min(255, r*0.5 + 80);
        const ng = Math.min(255, g*0.3 + 15);
        const nb = Math.min(255, b*1.4 + 60);
        data[i]=nr;data[i+1]=ng;data[i+2]=nb;
      }else if(currentFilter === 'night'){
        const gray = (r+g+b)/3;
        data[i]=0;data[i+1]=Math.min(255,gray*1.4+40);data[i+2]=0;
      }
    }
    ctx.putImageData(imgData,0,0);
  }

  function applyPortraitBlur(ctx,w,h){
    const copies = 3;
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tctx = tempCanvas.getContext('2d');
    tctx.drawImage(photoCanvas,0,0);
    const blurRadius = 18;
    ctx.save();
    ctx.globalAlpha = 0.32;
    for(let i=-copies;i<=copies;i++){
      for(let j=-copies;j<=copies;j++){
        const dx = i*4;
        const dy = j*4;
        ctx.drawImage(tempCanvas,dx,dy);
      }
    }
    ctx.restore();
    const focusHeight = h*0.35;
    const gradient = ctx.createLinearGradient(0,h*0.5 - focusHeight/2,0,h*0.5 + focusHeight/2);
    gradient.addColorStop(0,'rgba(0,0,0,0.9)');
    gradient.addColorStop(0.25,'rgba(0,0,0,0.4)');
    gradient.addColorStop(0.5,'rgba(0,0,0,0)');
    gradient.addColorStop(0.75,'rgba(0,0,0,0.4)');
    gradient.addColorStop(1,'rgba(0,0,0,0.9)');
    ctx.globalCompositeOperation = 'destination-in';
    ctx.fillStyle = gradient;
    ctx.fillRect(0,0,w,h);
    ctx.globalCompositeOperation = 'source-over';
    ctx.drawImage(tempCanvas,0,0);
  }

  function renderBaseFrame(){
    if(!stream) return;
    const track = stream.getVideoTracks();
    if(!track) return;
    const settings = track.getSettings ? track.getSettings() : {};
    const vidW = settings.width || video.videoWidth || photoCanvas.width;
    const vidH = settings.height || video.videoHeight || photoCanvas.height;
    const w = photoCanvas.width;
    const h = photoCanvas.height;
    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.translate(w/2,h/2);
    const flipX = mirrorEnabled ? -1 : 1;
    const flipY = flipEnabled ? -1 : 1;
    ctx.scale(flipX,flipY);
    const aspectVideo = vidW/vidH;
    const aspectCanvas = w/h;
    let drawW,drawH;
    if(aspectVideo > aspectCanvas){
      drawH = h;
      drawW = h * aspectVideo;
    }else{
      drawW = w;
      drawH = w / aspectVideo;
    }
    ctx.drawImage(video, -drawW/2, -drawH/2, drawW, drawH);
    ctx.restore();
    applyFilter(ctx,w,h);
    if(portraitBlur){
      applyPortraitBlur(ctx,w,h);
    }
    if(letterboxEnabled){
      const barH = h*0.12;
      ctx.fillStyle = 'rgba(0,0,0,0.96)';
      ctx.fillRect(0,0,w,barH);
      ctx.fillRect(0,h-barH,w,barH);
    }
    if(grainEnabled){
      ctx.fillStyle='rgba(255,255,255,0.04)';
      for(let i=0;i<300;i++){
        const x = Math.random()*w;
        const y = Math.random()*h;
        const s = Math.random()*1.2;
        ctx.fillRect(x,y,s,s);
      }
    }
    renderMemeOverlays(ctx,w,h);
    renderStickerOverlays(ctx);
    if(drawingEnabled){
      ctx.drawImage(drawCanvas,0,0);
    }
  }

  function renderMemeOverlays(ctx,w,h){
    const topText = currentMemeTop.trim();
    const bottomText = currentMemeBottom.trim();
    if(!memeEnabled || (!topText && !bottomText)) return;
    ctx.save();
    const fontSize = Math.max(20,Math.round(h*0.06));
    ctx.font = '900 '+fontSize+'px system-ui, -apple-system, BlinkMacSystemFont, "Impact", sans-serif';
    ctx.textAlign='center';
    ctx.strokeStyle='rgba(0,0,0,0.9)';
    ctx.lineWidth=fontSize*0.16;
    ctx.fillStyle='#ffffff';
    ctx.textBaseline='top';
    if(topText){
      const x=w/2;
      const y=h*0.08;
      ctx.strokeText(topText.toUpperCase(),x,y);
      ctx.fillText(topText.toUpperCase(),x,y);
    }
    if(bottomText){
      const x=w/2;
      const y=h*0.8;
      ctx.textBaseline='top';
      ctx.strokeText(bottomText.toUpperCase(),x,y);
      ctx.fillText(bottomText.toUpperCase(),x,y);
    }
    ctx.restore();
  }

  function renderStickerOverlays(ctx){
    stickers.forEach(function(s){
      ctx.save();
      ctx.font = s.size+'px system-ui, emoji';
      ctx.textBaseline='top';
      ctx.fillText(s.emoji,s.x,s.y);
      ctx.restore();
    });
  }

  function capturePhotoSequence(count){
    if(count <= 0) return;
    renderBaseFrame();
    const dataUrl = photoCanvas.toDataURL('image/png');
    addToGallery({type:'image',src:dataUrl});
    if(count>1){
      setTimeout(function(){capturePhotoSequence(count-1);},180);
    }
  }

  function playVibration(ms){
    if(!navigator.vibrate || !vibrateToggle.checked) return;
    try{
      navigator.vibrate(ms);
    }catch(e){}
  }

  function createAudioContext(){
    if(window.AudioContext || window.webkitAudioContext){
      try{
        return new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){
        return null;
      }
    }
    return null;
  }

  function playSound(buffer){
    if(!buffer) return;
    if(!audioContext){
      audioContext = createAudioContext();
    }
    if(!audioContext) return;
    const source = audioContext.createBufferSource();
    source.buffer = buffer;
    source.connect(audioContext.destination);
    source.start();
  }

  function createShutterSound(){
    const ac = createAudioContext();
    if(!ac) return null;
    const sr = ac.sampleRate;
    const duration = 0.12;
    const buffer = ac.createBuffer(1, duration*sr, sr);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){
      const t=i/sr;
      const env = Math.exp(-30*t);
      const osc = Math.sin(2*Math.PI*800*t) + 0.6*Math.sin(2*Math.PI*1400*t);
      data[i] = env*osc*0.6;
    }
    ac.close();
    return buffer;
  }

  function createTimerBeep(){
    const ac = createAudioContext();
    if(!ac) return null;
    const sr = ac.sampleRate;
    const duration = 0.25;
    const buffer = ac.createBuffer(1, duration*sr, sr);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++){
      const t=i/sr;
      const env = Math.exp(-6*t);
      const f = 550;
      const osc = Math.sin(2*Math.PI*f*t);
      data[i] = env*osc*0.5;
    }
    ac.close();
    return buffer;
  }

  function initAudioAnalyser(){
    if(!stream) return;
    if(!createAudioContext()) return;
    audioContext = audioContext || createAudioContext();
    if(!audioContext) return;
    const source = audioContext.createMediaStreamSource(stream);
    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 64;
    source.connect(analyserNode);
    startVisualizerLoop();
  }

  function startVisualizerLoop(){
    if(!analyserNode) return;
    const bufferLength = analyserNode.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    function animate(){
      if(!musicReactive || !analyserNode){
        musicVisualizer.classList.remove('active');
        return;
      }
      requestAnimationFrame(animate);
      analyserNode.getByteFrequencyData(dataArray);
      const chunkSize = Math.floor(bufferLength / visualBars.length);
      musicVisualizer.classList.add('active');
      for(let i=0;i<visualBars.length;i++){
        let sum=0;
        for(let j=0;j<chunkSize;j++){
          sum += dataArray[i*chunkSize + j];
        }
        const avg = sum / chunkSize;
        const scale = 0.25 + (avg/255)*1.6;
        visualBars[i].style.transform = 'scaleY('+scale.toFixed(2)+')';
      }
    }
    animate();
  }

  function startCapture(){
    if(currentMode === 'photo'){
      triggerPhotoCapture();
    }else{
      toggleVideoRecording();
    }
  }

  function triggerPhotoCapture(){
    const doCapture = function(){
      if(burstEnabled){
        capturePhotoSequence(5);
      }else{
        capturePhotoSequence(1);
      }
      playVibration(30);
      if(audioStateBadge.textContent === 'On'){
        playSound(shutterClickBuffer);
      }
    };
    if(timerSeconds>0){
      let remaining = timerSeconds;
      setStatus('Timer', 'info');
      timerIndicator.textContent = remaining+'s';
      const interval = setInterval(function(){
        remaining--;
        if(audioStateBadge.textContent === 'On'){
          playSound(timerBeepBuffer);
        }
        if(remaining<=0){
          clearInterval(interval);
          timerIndicator.textContent='';
          doCapture();
        }else{
          timerIndicator.textContent = remaining+'s';
        }
      },1000);
    }else{
      doCapture();
    }
  }

  function toggleVideoRecording(){
    if(mediaRecorder && mediaRecorder.state === 'recording'){
      mediaRecorder.stop();
      setStatus('Recording stopped', 'info');
      shutterBtn.classList.remove('recording');
      statusDot.classList.remove('rec');
      return;
    }
    const canvasStream = photoCanvas.captureStream(30);
    if(!canvasStream){
      setStatus('Recording not supported', 'info');
      return;
    }
    mediaRecorder = null;
    recordedChunks = [];
    const mimeTypes = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm'];
    let mimeType = '';
    for(let i=0;i<mimeTypes.length;i++){
      if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mimeTypes[i])){
        mimeType = mimeTypes[i];
        break;
      }
    }
    try{
      mediaRecorder = new MediaRecorder(canvasStream, mimeType ? {mimeType:mimeType}:{});
    }catch(e){
      console.error(e);
      setStatus('Recorder error', 'info');
      return;
    }
    mediaRecorder.ondataavailable = function(ev){
      if(ev.data && ev.data.size>0){
        recordedChunks.push(ev.data);
      }
    };
    mediaRecorder.onstop = function(){
      const blob = new Blob(recordedChunks, {type:'video/webm'});
      if(boomerangMode){
        generateBoomerang(blob);
      }else{
        const url = URL.createObjectURL(blob);
        addToGallery({type:'video',src:url});
      }
    };
    mediaRecorder.start();
    shutterBtn.classList.add('recording');
    statusDot.classList.add('rec');
    setStatus('Recording', 'rec');
    let recordedMs = 0;
    const maxMs = 9000;
    const interval = setInterval(function(){
      recordedMs += 200;
      if(mediaRecorder && mediaRecorder.state === 'recording'){
        timerIndicator.textContent = (recordedMs/1000).toFixed(1)+'s';
        if(recordedMs >= maxMs){
          mediaRecorder.stop();
        }
      }else{
        clearInterval(interval);
        timerIndicator.textContent = '';
      }
    },200);
  }

  function generateBoomerang(blob){
    const videoEl = document.createElement('video');
    videoEl.src = URL.createObjectURL(blob);
    videoEl.muted = true;
    videoEl.playsInline = true;
    videoEl.addEventListener('loadeddata', function(){
      const offCanvas = document.createElement('canvas');
      const maxDim = 640;
      const ratio = Math.min(maxDim/videoEl.videoWidth, maxDim/videoEl.videoHeight, 1);
      offCanvas.width = videoEl.videoWidth * ratio;
      offCanvas.height = videoEl.videoHeight * ratio;
      const offCtx = offCanvas.getContext('2d');
      const frames = [];
      const fps = 25;
      const frameDuration = 1/fps;
      let currentTime = 0;
      function captureFrames(){
        if(currentTime > videoEl.duration){ 
          processFrames(frames, offCanvas);
          return;
        }
        videoEl.currentTime = currentTime;
        videoEl.addEventListener('seeked', function handler(){
          videoEl.removeEventListener('seeked', handler);
          offCtx.drawImage(videoEl,0,0,offCanvas.width,offCanvas.height);
          const img = new Image();
          img.src = offCanvas.toDataURL('image/webp');
          frames.push(img);
          currentTime += frameDuration;
          captureFrames();
        });
      }
      captureFrames();
    });
  }

  function processFrames(frames, canvas){
    if(!frames.length){
      setStatus('Boomerang failed', 'info');
      return;
    }
    const ctx2 = canvas.getContext('2d');
    const playbackStream = canvas.captureStream(25);
    let boomerRecorder;
    let boomerChunks = [];
    try{
      boomerRecorder = new MediaRecorder(playbackStream, {mimeType:'video/webm'});
    }catch(e){
      console.error(e);
      setStatus('Boomerang not supported', 'info');
      return;
    }
    boomerRecorder.ondataavailable = function(ev){
      if(ev.data && ev.data.size>0){
        boomerChunks.push(ev.data);
      }
    };
    boomerRecorder.onstop = function(){
      const blob = new Blob(boomerChunks, {type:'video/webm'});
      const url = URL.createObjectURL(blob);
      addToGallery({type:'video',src:url,label:'Boom'});
    };
    const sequence = frames.concat(frames.slice().reverse());
    let index = 0;
    boomerRecorder.start();
    function renderLoop(){
      if(index >= sequence.length){
        boomerRecorder.stop();
        return;
      }
      const img = sequence[index];
      ctx2.clearRect(0,0,canvas.width,canvas.height);
      ctx2.drawImage(img,0,0,canvas.width,canvas.height);
      index++;
      setTimeout(renderLoop,40);
    }
    renderLoop();
  }

  function addToGallery(item){
    galleryItems.push(item);
    const cell = document.createElement('div');
    cell.className = 'gallery-item';
    let el;
    if(item.type === 'image'){
      el = document.createElement('img');
      el.src = item.src;
    }else{
      el = document.createElement('video');
      el.src = item.src;
      el.muted = true;
      el.loop = true;
      el.playsInline = true;
      el.autoplay = true;
    }
    cell.appendChild(el);
    const tag = document.createElement('div');
    tag.className = 'gallery-tag';
    tag.textContent = item.type === 'image' ? 'Photo' : (item.label || 'Video');
    cell.appendChild(tag);
    const badge = document.createElement('div');
    badge.className = 'gallery-badge';
    badge.textContent = item.type === 'image' ? 'P' : 'V';
    cell.appendChild(badge);
    cell.addEventListener('click', function(){
      if(item.type === 'image'){
        downloadLink.href = item.src;
        downloadLink.download = 'neon-frame.png';
        downloadLink.click();
      }else{
        const win = window.open();
        if(win){
          win.document.write('<video src="'+item.src+'" controls autoplay style="width:100%;height:100%;object-fit:contain;background:#000"></video>');
        }
      }
    });
    galleryGrid.prepend(cell);
  }

  function clearGallery(){
    galleryItems.forEach(function(item){
      if(item.type === 'video'){
        try{
          URL.revokeObjectURL(item.src);
        }catch(e){}
      }
    });
    galleryItems = [];
    galleryGrid.innerHTML='';
    if(!privacyToggle.checked){
      localStorage.removeItem(STORAGE_KEY);
    }
  }

  function saveSnapshotState(){
    if(privacyToggle.checked) return;
    const snapshot = {
      filter: currentFilter,
      mirror: mirrorEnabled,
      flip: flipEnabled,
      portrait: portraitBlur,
      letterbox: letterboxEnabled,
      grain: grainEnabled
    };
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));
    }catch(e){}
  }

  function restoreSnapshotState(){
    try{
      const data = localStorage.getItem(STORAGE_KEY);
      if(!data) return;
      const snapshot = JSON.parse(data);
      currentFilter = snapshot.filter || 'none';
      mirrorEnabled = !!snapshot.mirror;
      flipEnabled = !!snapshot.flip;
      portraitBlur = !!snapshot.portrait;
      letterboxEnabled = !!snapshot.letterbox;
      grainEnabled = !!snapshot.grain;
      updateFilterChips();
      mirrorBtn.classList.toggle('primary',mirrorEnabled);
      flipBtn.classList.toggle('primary',flipEnabled);
      portraitToggle.checked = portraitBlur;
      letterboxToggle.checked = letterboxEnabled;
      grainToggle.checked = grainEnabled;
      letterboxes.forEach(function(lb){lb.style.display = letterboxEnabled?'block':'none';});
      filmGrain.style.opacity = grainEnabled ? '0.55':'0';
    }catch(e){}
  }

  function updateFilterChips(){
    const chips = Array.from(filtersRow.querySelectorAll('.chip'));
    chips.forEach(function(chip){
      const f = chip.getAttribute('data-filter');
      chip.classList.toggle('active',f === currentFilter);
    });
  }

  function setMode(mode){
    currentMode = mode;
    photoModeChip.classList.toggle('active',mode==='photo');
    videoModeChip.classList.toggle('active',mode==='video');
    boomerangModeChip.classList.toggle('active',mode==='boomerang');
    boomerangMode = mode==='boomerang';
    if(mode === 'photo'){
      shutterBtn.classList.remove('recording');
      statusDot.classList.remove('rec');
      setStatus('Photo mode', 'info');
    }else if(mode === 'video'){
      setStatus('Video mode', 'info');
    }else{
      setStatus('Boomerang mode', 'info');
    }
  }

  function onFiltersRowClick(e){
    const chip = e.target.closest('.chip');
    if(!chip) return;
    const f = chip.getAttribute('data-filter');
    currentFilter = f;
    updateFilterChips();
    saveSnapshotState();
  }

  function onPortraitToggleChange(){
    portraitBlur = portraitToggle.checked;
    saveSnapshotState();
  }

  function onGrainToggleChange(){
    grainEnabled = grainToggle.checked;
    filmGrain.style.opacity = grainEnabled ? '0.55':'0';
    saveSnapshotState();
  }

  function onLetterboxToggleChange(){
    letterboxEnabled = letterboxToggle.checked;
    letterboxes.forEach(function(lb){lb.style.display = letterboxEnabled?'block':'none';});
    saveSnapshotState();
  }

  function onTimerChipClick(chip){
    timerChips.forEach(function(c){c.classList.remove('active');});
    chip.classList.add('active');
    const val = parseInt(chip.getAttribute('data-timer'),10);
    timerSeconds = isNaN(val) ? 0 : val;
  }

  function onBurstToggle(){
    burstEnabled = !burstEnabled;
    burstChip.classList.toggle('secondary-active', burstEnabled);
  }

  function onMemeInputsChange(){
    currentMemeTop = memeTopInput.value || '';
    currentMemeBottom = memeBottomInput.value || '';
  }

  function onEmojiClick(e){
    const target = e.target.closest('.emoji-chip');
    if(!target) return;
    const emoji = target.textContent;
    const rect = previewRoot.getBoundingClientRect();
    const x = rect.width*0.5 - 20 + (Math.random()*40-20);
    const y = rect.height*0.55;
    stickers.push({emoji:emoji,x:x,y:y,size:38});
    setStatus('Sticker added', 'info');
  }

  function onDrawToggleChange(){
    drawingEnabled = drawToggle.checked;
    drawCanvas.style.pointerEvents = drawingEnabled ? 'auto':'none';
    if(!drawingEnabled){
      isDrawing=false;
    }
  }

  function onMemeToggleChange(){
    memeEnabled = memeToggle.checked;
  }

  function onBrushChange(){
    brushSize = parseInt(brushRange.value,10) || 8;
  }

  function pointerPos(evt){
    const rect = drawCanvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches.clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches.clientY : evt.clientY;
    const x = (clientX - rect.left);
    const y = (clientY - rect.top);
    return {x:x,y:y};
  }

  function startDraw(evt){
    if(!drawingEnabled) return;
    evt.preventDefault();
    isDrawing = true;
    const pos = pointerPos(evt);
    lastPoint = pos;
  }

  function moveDraw(evt){
    if(!drawingEnabled || !isDrawing) return;
    evt.preventDefault();
    const pos = pointerPos(evt);
    drawCtx.strokeStyle = '#f97316';
    drawCtx.lineWidth = brushSize;
    drawCtx.lineJoin = 'round';
    drawCtx.lineCap = 'round';
    drawCtx.beginPath();
    drawCtx.moveTo(lastPoint.x,lastPoint.y);
    drawCtx.lineTo(pos.x,pos.y);
    drawCtx.stroke();
    lastPoint = pos;
  }

  function endDraw(evt){
    if(!drawingEnabled) return;
    evt.preventDefault();
    isDrawing=false;
    lastPoint=null;
  }

  function onMusicReactiveChange(){
    musicReactive = musicReactiveToggle.checked;
    if(musicReactive){
      if(!audioContext){
        initAudioAnalyser();
      }else{
        startVisualizerLoop();
      }
    }else{
      musicVisualizer.classList.remove('active');
    }
  }

  function onPrivacyChange(){
    if(privacyToggle.checked){
      privacyBadge.textContent = 'Privacy: Session Only';
      localStorage.removeItem(STORAGE_KEY);
    }else{
      privacyBadge.textContent = 'Privacy: Snapshot Saved';
      saveSnapshotState();
    }
  }

  function onSaveSnapshotClick(){
    if(!galleryItems.length){
      setStatus('Nothing to save', 'info');
      return;
    }
    saveSnapshotState();
    setStatus('Snapshot saved (settings)', 'info');
  }

  function onClearGalleryClick(){
    clearGallery();
    setStatus('Gallery cleared', 'info');
  }

  function onMirrorClick(){
    mirrorEnabled = !mirrorEnabled;
    mirrorBtn.classList.toggle('primary',mirrorEnabled);
    saveSnapshotState();
  }

  function onFlipClick(){
    flipEnabled = !flipEnabled;
    flipBtn.classList.toggle('primary',flipEnabled);
    saveSnapshotState();
  }

  function onAudioBadgeClick(){
    const on = audioStateBadge.textContent === 'On';
    audioStateBadge.textContent = on ? 'Off':'On';
  }

  function initEvents(){
    filtersRow.addEventListener('click', onFiltersRowClick);
    portraitToggle.addEventListener('change', onPortraitToggleChange);
    grainToggle.addEventListener('change', onGrainToggleChange);
    letterboxToggle.addEventListener('change', onLetterboxToggleChange);

    timerChips.forEach(function(chip){
      chip.addEventListener('click', function(){onTimerChipClick(chip);});
    });
    timerNoneChip.classList.add('active');

    burstChip.addEventListener('click', onBurstToggle);

    memeTopInput.addEventListener('input', onMemeInputsChange);
    memeBottomInput.addEventListener('input', onMemeInputsChange);
    emojiRow.addEventListener('click', onEmojiClick);

    drawToggle.addEventListener('change', onDrawToggleChange);
    memeToggle.addEventListener('change', onMemeToggleChange);
    brushRange.addEventListener('input', onBrushChange);

    drawCanvas.addEventListener('mousedown', startDraw);
    drawCanvas.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', endDraw);
    drawCanvas.addEventListener('touchstart', startDraw, {passive:false});
    drawCanvas.addEventListener('touchmove', moveDraw, {passive:false});
    window.addEventListener('touchend', endDraw);

    musicReactiveToggle.addEventListener('change', onMusicReactiveChange);
    privacyToggle.addEventListener('change', onPrivacyChange);

    saveAllBtn.addEventListener('click', onSaveSnapshotClick);
    clearGalleryBtn.addEventListener('click', onClearGalleryClick);

    shutterBtn.addEventListener('click', startCapture);
    switchCameraBtn.addEventListener('click', switchCamera);
    mirrorBtn.addEventListener('click', onMirrorClick);
    flipBtn.addEventListener('click', onFlipClick);

    audioStateBadge.addEventListener('click', onAudioBadgeClick);

    photoModeChip.addEventListener('click', function(){setMode('photo');});
    videoModeChip.addEventListener('click', function(){setMode('video');});
    boomerangModeChip.addEventListener('click', function(){setMode('boomerang');});
  }

  function animationLoop(){
    requestAnimationFrame(animationLoop);
    if(!stream) return;
    renderBaseFrame();
  }

  window.addEventListener('load', function(){
    restoreSnapshotState();
    initEvents();
    initCamera();
    animationLoop();
  });

  if('vibrate' in navigator){
  }

})();
</script>
</body>
</html>

[1](https://staff.emu.edu.tr/nazifedimililer/Documents/courses/itec513/%5BHans_van_Vliet%5D_Software_Engineering_Principles_(BookFi)-2.pdf)
[2](https://softskills.audio/feed.xml)
[3](https://www.psscive.ac.in/storage/uploads/textbooks/pdf/english/web-developer-new-25-job-role-english-class-%2012.pdf)
[4](https://www.du.ac.in/uploads/new-web/28032023_SEC.pdf)
[5](https://oa.upm.es/84328/1/book_english_version.pdf)
[6](https://paul.kinlan.me/simple-boomerang-video/)
[7](http://noisehack.com/build-music-visualizer-web-audio-api/)
[8](https://github.com/zxing-js/ngx-scanner/issues/331)
[9](https://www.suniv.ac.in/docs/AICTE-%20BBA%20syllabus%20(NEP-2020).pdf)
[10](https://paul.kinlan.me/chrome-bug-897727mediarecorder-using-canvas-capturestreamfails-for-large-canvas-elements-on-android/)
